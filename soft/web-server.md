# Настраиваем веб-сервер для работы с PHP из браузера

Это урок для тех, кто уже знает основы языка PHP. В нем мы узнаем как работает, установим и научимся запускать встроенный в PHP веб-сервер, а также веб-сервер Апач.

Прежде чем все это делать, нам надо понять, зачем нужен веб-сервер и как работает браузер, когда загружает страницу.

## Как работает браузер

Браузер - это программа, которая загружает с веб-сервера и отображает на экране веб-страницы. Когда ты переходишь по ссылке или руками вводишь в адресную строку адрес вроде http://example.com/news.html, происходит следующее: 

- браузер устанавливает соединение через интернет с узлом example.com, с запущенной на нем программой под названием веб-сервер
- браузер посылает программе-веб-серверу запрос по протоколу HTTP (протокол - это язык для общения программ между собой) с просьбой предоставить ему страницу по адресу example.com/news.html
- веб-сервер в ответ отправляет HTML-файл, содержащий тело странцы
- браузер отображает этот файл на экране. Если страница включает в себя другие файлы, например, картинки или видеоролики, браузер для каждого из них устанавливает новое соединение и отправляет новый запрос на сервер

Протокол HTTP позволят не только скачивать страницы или файлы с сервера, но и отправлять на сервер данные из форм (например при отправке комментария к видео) или загружать на сервер файлы (например в приложении-файлообменнике). 

Протокол HTTP поддерживает 2 основных вида запросов (они называются *методы*): `GET` и `POST`. Метод `GET` используется для получения с сервера файлов и страниц (это одно и то же, так как веб-страница - это просто файл в формате HTML). Метод `POST` позволяет отправлять на сервер формы, в том числе с приложенными файлами.

Вот пример HTTP-запроса, который может послать браузер в описанной ситуации: 

```
GET /news.html HTTP/1.1
Host: example.com
User-Agent: Chromius/43
Accept: text/html,application/xhtml+xml,application/xml
Accept-Language: ru, en
```

Как видишь, в нем указан метод (`GET`), адрес страницы (`/news.html`) и имя сервера (`example.com`), а также дополнительные *заголовки* содержащие название и версию браузера, информацию о поддерживаемых им форматах файлов и предпочитаемом языке для страницы. Вот как может выглядеть ответ на этот запрос: 

```
HTTP/1.1 200 Ok
Server: nginx/1.0.0
Date: Sat, 11 Jul 2015 01:54:57 GMT
Content-Type: text/html; charset=UTF-8

<!DOCTYPE html>
<p>Hello World</p>
```

Как видишь, сервер в ответ сообщил что запрос обработан успешно, такая страница на сервере есть (`200 Ok`). Также он сообщил свое название и версию (`nginx/1.0.0`), текущее время, и тип отправленного в ответ файла (файл в формате HTML, в кодировке utf-8).

Ниже идет сам HTML-файл (начиная с `<!DOCTYPE...`). HTML файл содержит текст страницы и специальные *теги* (метки) вроде `<p>` которые разбивают этот текст на абзацы, заголовки, позволяют добавлять в него ссылки, картинки, формы и многое другое. Ты можешь увидеть полученный от сервера HTML-код любой страницы в интернете, зайдя на нее и нажав Ctrl + U в браузере или выбрав в меню что-то вроде "Вид" - "Показать исходный код страницы". 

Формат запросов и ответов, поведение веб-сервера описано в документации к протоколу HTTP. Если тебе интересны подробности, можно начать с Википедии: https://ru.wikipedia.org/wiki/HTTP

Ты можешь увидеть какой именно запрос отправляет твой браузер, зайдя на любой сайт, открыв developer tools на вкладке Network (Ctrl + Shift + I в Хроме (и его клонах вроде яндекс-браузера), Опере, Фаерфоксе, F12 в ИЕ, через меню "инструменты" в Сафари) и перезагрузив страницу. Ты увидишь список отправленных HTTP запросов, а при клике по ним сможешь их посмотреть.

Таким образом, задача браузера - отправить запрос на сервер, получить HTML файл и отобразить на экране. А задача веб-сервера - принимать и выполнять запросы от браузера, например предоставлять (или генерировать) запрошенные файлы и страницы. 

## Статические и динамические сайты

Есть 2 варианта, откуда веб-сервер может получать веб-страницы (HTML-файлы), которые он отдает в браузер. На *статических* сайтах все страницы сайта лежат в виде HTML-файлов на жестком диске сервера. Сервер по запросу просто берет страницу с диска и отсылает в браузер. Статические сайты просто создавать, и они быстро работают, но у них есть недостаток: они не интерактивны, на них нельзя сделать регистрацию, добавление комментариев, постов, лайки и другие вещи к которым мы все привыкли. Чтобы изменить что-то на таком сайте, веб-мастер должен вручную отредактировать эти HTML файлы и загрузить на сервер.

Также, статический сайт имеет еще одну особенность: так как это просто набор файлов, то его можно просматривать даже без веб-сервера и связи с интернетом. Достаточно скачать HTML файл со страницей себе на компьютер (например нажав Ctrl + S в браузере), после чего перетащить в окно браузера - браузер отобразит сохраненную страницу. 

*Динамические* сайты работают по другому принципу. В них страница генерируется программно. При поступлении запроса от браузера веб-сервер запускает программу (например, на PHP), и то, что выведет эта программа, веб-сервер отправит в браузер в качестве ответа на запрос. Обычно программа хранит данные сайта (статьи, новости, комментарии, пользователей) в базе данных, потому при поступлении запроса эти данные берутся из базы и подставляются в шаблон страницы. 

Динамические сайты сложнее, гораздо сильнее нагружают процессор (на 2016 год типичный статический сайт может обработать десятки тысяч запросов в секунду, а динамический - несколько сотен), но зато они позволяют реализовать взаимодействие с пользователями. Например, при отправке пользователем комментария программа может добавлять его в базу данных и он появится на странице. Также, автор сайта может размещать на нем статьи через редактор в админке ("админка" - это административный интерфейс, закрытая часть сайта позволяющая управлять им), а не через правку HTML кода. Потому большинство сайтов в интернете - динамические.

Язык PHP заточен под создание динамических сайтов, что и сделало его очень популярным. Есть и другие языки, пригодные для этого - например, Java, Ruby, Python, Javascript, C# - но на PHP простые страницы сделать проще.

## Веб-сервер

Итак, как ты уже понял, для того, чтобы делать динамические сайты, кроме программы на языке PHP, нам понадобится веб-сервер (чтобы отвечать на запросы браузера) и интерпретатор PHP (чтобы выполнять нашу программу при поступлении запроса). Есть несколько разных программ-серверов (встроенный в php сервер, apache, nginx) и несколько схем взаимодействия сервера с интерпретатором PHP (PHP можно подключить как модуль Апача, или запустить под управлением php-fpm отдельно от сервера). 

## Встроенный в PHP сервер

В интерпретатор PHP встроен простой веб-сервер. Его не стоит использовать на реальном сайте, но он годится для того, чтобы запускать простые скрипты на своем компьютере. Чтобы им воспользоваться, нам надо сначала установить интерпретатор PHP.

- если ты используешь винду: следуй инструкциям в [уроке по установке PHP на Windows](../soft/php-install.md) 
- если ты используешь Мак, то в нем есть PHP, но он не очень новый. Если тебе нужна новая версия, придется разобраться с homebrew или аналогичной системой установки программ
- если ты используешь дебиан или убунту, то установка делается командой `apt-get install php5`
- если ты используешь андроид, то можно найти приложение, предоставляющее php, но не знаю, удобно ли с ним будет работать

Инструкции ниже требуют знания командной строки, если ты не знаешь ее, то прочти сначала урок по ней.

Итак, в PHP встроен простейший веб-сервер для разработчиков. Чтобы запустить его, создай папку, из которой будут раздаваться файлы и в которой будут лежать PHP-скрипты. Допустим, это d:\server. Открой командную строку и перейди в эту папку, а затем запусти веб-сервер: 

```
d:
cd \server
c:\php\php.exe -S localhost:9001
```

`-S` обозначает «запуститься в режиме сервера». Надо написать именно заглавную S, c маленькой буквой не заработает. `localhost` (вместо него можно еще писать 127.0.0.1 - это твой собственный адрес) обозначает принимать соединения только со своего компьютера, и не принимать соединения с других устройств (если хочешь чтобы твой сервер был доступен во всей локальной сети, пиши вместо localhost адрес 0.0.0.0 — после этого к тебе можно будет зайти по ip).

9091 — это номер порта, на котором сервер будет ждать соединения от браузера. Если произойдет ошибка и будет написано что этот порт уже занят, введи другое число (от 1 до 65534), например 9092. Вообще-то обычно для веб-сервера используется порт 80, но у тебя он может быть занят другими программами - например, скайпом, торрентокачалкой или чем-то еще (если это так, стоит зайти в их настройки и запретить его использовать на будущее). Ты можешь увидеть список занятых портов командой `netstat -an`, а команда `netstat -abn` покажет программу, занявшую порт (нужно запускать эту команду из консоли с повышенными привилегиями).

Учти что в линуксе и маке, чтобы открыть порт ниже 1024, нужны права администратора (то есть сервер надо запускать через sudo: `sudo php ...`, что не очень безопасно и не рекомендуется). 

Завершить работу сервера можно, нажав Ctrl + C или закрыв окно консоли. Сервер будет в процессе работы писать в консоль информацию о поступающих от браузера запросах и информацию об ошибках.

Теперь надо проверить, как работает наш сервер. Создай в папке сервера файл, например 1.txt и напиши в нем hello world. После этого открой браузер и введи в адресную строку адрес

http://localhost:9091/1.txt

Если все верно, ты должен увидеть содержимое текстового файла, а в консоли появится строчка с этим запросом. Если что-то не работает - перепроверяй, запущен ли php, что он пишет в консоль, правильно ли ты написал слово localhost и номер порта. 

В данном случае мы запросили текстовый файл, и веб-сервер отдал его браузеру с диска, как на статических сайтах. А что, если мы попробуем запросить php скрипт? Создай в папке веб-сервера файл time.php и напиши в нем 

```php
<?php echo date('r');
```

Теперь открой URL http://localhost:9091/time.php - в браузере должно отобразиться текущее время. Обнови страницу и убедись, что время тоже обновляется. 

Если ты видишь вместо него белую страницу, а исходный код в браузере показыает текст скрипта - значит скрипт не выполнился. Проверь, правильный ли URL в адресной строке браузера. Если там что-то вроде file://c:/server/time.php - значит ты невнимательно прочел инструкции выше.

Наконец, давай сделаем еще один файл, который показывает текущие настройки PHP и который пригодится нам если что-то пойдет не так. Создай файл info.php с текстом: 

<?php phpinfo();

И открой через браузер. Ты увидишь большую синюю таблицу - поизучай ее, она пригодится тебе не раз, когда ты будешь разбираться почему что-то не работает.

В этом месте ты можешь достать свои старые задачи, которые ты делал на PHP, и попробовать позапускать их через сервер и браузер. 

### Пробелы и перевод строки

Чтобы переносы строк нормально работали и в браузере, и при запуске скрипта в консоли, можно использовать для них традиционный \n, а в начале программы поставить
    
```php
header("Content-Type: text/plain; charset=utf-8");
```

Это заставит браузер воспринимать то, что выводит твоя программа, как обычный текст, а не HTML, и уважать переносы строк в нем.  Иначе перенос строки будет в исходном коде страницы (его можно увидеть нажав Ctrl + U), но на самой странице его не будет.

Ведь по умолчанию веб-сервер отдает результат в браузер, говоря что это HTML-файл, а в этом языке любое число пробелов и переводов строк выводится как один пробел. Отдавая заголовок `Content-Type`, мы говорим браузеру что наш файл содержит обычный текст и не должен интерпретироваться как HTML код.

## Установка Апача

Апач сложнее чем встроенный сервер, но дает больше возможностей. 

Урок: (../soft/apache-install.md)

## Что делать дальше

Ты наверно заметил, что в тексте выше не раз повторяется слово HTML. Это неспроста - на этом языке верстаются веб-страницы. Иди и изучи основы этого языка, чтобы ты умел сверстать хотя бы страницу с заголовком, картинкой и ссылкой. Это займет у тебя максимум пару дней.

Полезно также будет прочитать про протокол HTTP, методы, заголовки, коды ответа, куки - это все пригодится в дальнейшем.

Наконец, стоит почитать туториал в официальном мануале PHP и научиться добавлять в HTML странички PHP код, а также обрабатывать данные из форм: 

- http://php.net/manual/ru/tutorial.php
- http://php.net/manual/ru/language.basic-syntax.php

После этого прочитай про шаблоны: http://www.phpinfo.su/articles/practice/shablony_v_php.html

Изучив все это, попробуй решить задачи ниже. Если ты смог их решить - отлично, ты готов к написанию своего первого веб-приложения на PHP - задаче про список студентов.

## Полезные функции и конструкции PHP, которые стоит изучить

- `require`, `require_once`
- `header()`
- `setcookie()`

## Задачи

### Еще один кредит

Сделай форму с 3 полями ввода: сумма кредита, ежемесячная выплата, комиссия и проценты в месяц. При их заполнении программа должна рассчитать кредит (аналогично задаче про айфон) и вывести один из вариантов: 

- надпись "поле X заполнено неверно", если введены неправильные данные
- надпись "выплатить кредит невозможно так как ежемесячный прирост X больше ежемесячной выплаты", если выплатить кредит не получится
- надпись "время выплаты: N месяцев, сумма выплаты: X"

### Экранирование

Сделай страницу с формой (использующей метод GET) из поля ввода textarea (с именем text) и кнопки отправки. Никакого оформления и CSS не требуется, просто черный текст на белом фоне. При вводе любого текста и нажатия кнопки внизу под textarea должен отобразиться введенные текст и ссылка. 

Текст должен точно соответствовать введенному, корректно отображать все символы, включая пробелы и переводы строк (тут тебе поможет тег pre), точно так как их ввел пользователь. Проверь что сочетания вроде

```
%20%20
<b>test
&amp;amp;
"'\<>
&t=1&
```

Отображаются ровно в том же виде как введены.

Кроме текста, надо выводить ссылку вида script.php?text=.....&lt=1, которая содержит в параметре text введенный текст, а в параметре lt единицу и открыв которую, мы можем увидеть  его на странице. 

Это задача на умение правильно экранировать символы. Например, в языке HTML символы вроде `<` или `&`  имеют специальное значение (они открывают тег или HTML мнемонику) и их надо правильно экранировать. Аналогично с параметрами ссылки. 

### Я тебя помню

Сделай скрипт, запоминающий сколько раз пользователь заходил на страницу и показывающий ему это число: "добро пожаловать - в N-й раз". Для хранения надо использовать куки, чтобы у каждого пользователя был свой счетчик.

Проверь что при открытии окна браузера в анонимном режиме или другого браузера счетчик в нем работает независимо, а при очистке кук сбрасывается в 0. 

Просмотреть куки можно с помощью developer tools в браузере. 

